# Publish to crates.io on tag
name: Publish to crates.io

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Publish gldf-rs (core library) first - all other crates depend on it
  publish-lib:
    name: Publish gldf-rs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify build
        run: cargo build --release -p gldf-rs

      - name: Run tests
        run: cargo test -p gldf-rs

      - name: Dry run publish
        run: cargo publish --dry-run -p gldf-rs

      - name: Publish gldf-rs to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p gldf-rs --allow-dirty || echo "Already published or failed"

  # Publish gldf-rs-ffi (FFI bindings for mobile) after gldf-rs
  publish-ffi:
    name: Publish gldf-rs-ffi
    runs-on: ubuntu-latest
    needs: publish-lib
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Wait for crates.io index update
        run: sleep 60

      - name: Update crates.io index
        run: cargo update -p gldf-rs || true

      - name: Verify build (local workspace)
        run: cargo build --release -p gldf-rs-ffi

      - name: Publish gldf-rs-ffi to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p gldf-rs-ffi --allow-dirty --no-verify || echo "Already published or failed"

  # Publish gldf-rs-wasm (WebAssembly viewer) after gldf-rs
  publish-wasm:
    name: Publish gldf-rs-wasm
    runs-on: ubuntu-latest
    needs: publish-lib
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Wait for crates.io index update
        run: sleep 60

      - name: Update crates.io index
        run: cargo update -p gldf-rs || true

      - name: Verify build (local workspace)
        run: cargo build --release -p gldf-rs-wasm --target wasm32-unknown-unknown

      - name: Publish gldf-rs-wasm to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p gldf-rs-wasm --allow-dirty --no-verify || echo "Already published or failed"

  # Publish gldf_rs_python (Python bindings) after gldf-rs
  publish-python:
    name: Publish gldf_rs_python
    runs-on: ubuntu-latest
    needs: publish-lib
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Wait for crates.io index update
        run: sleep 60

      - name: Update crates.io index
        run: cargo update -p gldf-rs || true

      - name: Verify build (local workspace)
        run: cargo build --release -p gldf_rs_python

      - name: Publish gldf_rs_python to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p gldf_rs_python --allow-dirty --no-verify || echo "Already published or failed"

  # Publish gldf-rs-egui (desktop viewer) after gldf-rs
  publish-egui:
    name: Publish gldf-rs-egui
    runs-on: ubuntu-latest
    needs: publish-lib
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev

      - name: Wait for crates.io index update
        run: sleep 60

      - name: Update crates.io index
        run: cargo update -p gldf-rs || true

      - name: Verify build (local workspace)
        run: cargo build --release -p gldf-rs-egui

      - name: Publish gldf-rs-egui to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p gldf-rs-egui --allow-dirty --no-verify || echo "Already published or failed"
