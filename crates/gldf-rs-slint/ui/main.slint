import { VerticalBox, HorizontalBox, Button, ListView, ScrollView,
         GroupBox, LineEdit, ComboBox, TabWidget, Spinner,
         StandardTableView, ProgressIndicator } from "std-widgets.slint";

// Data structures
export struct GldfFileInfo {
    id: string,
    name: string,
    content-type: string,
    file-type: string,  // "geometry", "image", "photometry", "document", "other"
}

export struct GldfHeader {
    manufacturer: string,
    author: string,
    format-version: string,
    created-with: string,
    creation-date: string,
}

export struct GldfStats {
    file-count: int,
    geometry-count: int,
    image-count: int,
    photometry-count: int,
    light-source-count: int,
    variant-count: int,
}

export struct LightSourceInfo {
    id: string,
    name: string,
    description: string,
    lumens: string,
}

// Main application window
export component GldfViewer inherits Window {
    title: "GLDF Viewer";
    min-width: 900px;
    min-height: 600px;
    background: #1e1e2e;

    // Properties bound from Rust
    in property <string> current-file: "";
    in property <bool> is-loading: false;
    in property <GldfHeader> header: {
        manufacturer: "",
        author: "",
        format-version: "",
        created-with: "",
        creation-date: "",
    };
    in property <GldfStats> stats: {
        file-count: 0,
        geometry-count: 0,
        image-count: 0,
        photometry-count: 0,
        light-source-count: 0,
        variant-count: 0,
    };
    in property <[GldfFileInfo]> files: [];
    in property <[LightSourceInfo]> light-sources: [];
    in property <string> selected-file-content: "";
    in property <string> status-message: "Ready";

    // Callbacks to Rust
    callback open-file();
    callback export-json();
    callback export-xml();
    callback file-selected(string);
    callback view-3d(string);

    VerticalBox {
        padding: 0px;
        spacing: 0px;

        // Menu bar
        Rectangle {
            height: 40px;
            background: #313244;

            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                spacing: 10px;
                alignment: start;

                Button {
                    text: "Open GLDF...";
                    enabled: !is-loading;
                    clicked => { open-file(); }
                }
                Button {
                    text: "Export JSON";
                    enabled: current-file != "" && !is-loading;
                    clicked => { export-json(); }
                }
                Button {
                    text: "Export XML";
                    enabled: current-file != "" && !is-loading;
                    clicked => { export-xml(); }
                }

                // Spacer
                Rectangle { horizontal-stretch: 1; }

                // Current file indicator
                Text {
                    text: current-file != "" ? "File: " + current-file : "No file loaded";
                    color: #cdd6f4;
                    vertical-alignment: center;
                }

                if is-loading: Spinner {
                    indeterminate: true;
                    width: 24px;
                    height: 24px;
                }
            }
        }

        // Main content
        HorizontalBox {
            padding: 10px;
            spacing: 10px;

            // Left sidebar - File list
            GroupBox {
                title: "Files (" + stats.file-count + ")";
                width: 280px;

                VerticalBox {
                    spacing: 5px;

                    // Filter buttons
                    HorizontalBox {
                        spacing: 5px;

                        Rectangle {
                            background: #45475a;
                            border-radius: 4px;
                            height: 24px;
                            horizontal-stretch: 1;

                            Text {
                                text: "3D: " + stats.geometry-count;
                                color: #a6e3a1;
                                font-size: 11px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                        Rectangle {
                            background: #45475a;
                            border-radius: 4px;
                            height: 24px;
                            horizontal-stretch: 1;

                            Text {
                                text: "Img: " + stats.image-count;
                                color: #89b4fa;
                                font-size: 11px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                        Rectangle {
                            background: #45475a;
                            border-radius: 4px;
                            height: 24px;
                            horizontal-stretch: 1;

                            Text {
                                text: "LDT: " + stats.photometry-count;
                                color: #f9e2af;
                                font-size: 11px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // File list
                    ScrollView {
                        vertical-stretch: 1;

                        VerticalBox {
                            spacing: 2px;
                            alignment: start;

                            for file in files: Rectangle {
                                height: 36px;
                                background: #313244;
                                border-radius: 4px;

                                HorizontalBox {
                                    padding: 8px;
                                    spacing: 8px;

                                    // File type indicator
                                    Rectangle {
                                        width: 8px;
                                        height: 8px;
                                        border-radius: 4px;
                                        background: file.file-type == "geometry" ? #a6e3a1 :
                                                   file.file-type == "image" ? #89b4fa :
                                                   file.file-type == "photometry" ? #f9e2af :
                                                   #6c7086;
                                    }

                                    VerticalBox {
                                        spacing: 2px;
                                        horizontal-stretch: 1;

                                        Text {
                                            text: file.name;
                                            color: #cdd6f4;
                                            font-size: 12px;
                                            overflow: elide;
                                        }
                                        Text {
                                            text: file.content-type;
                                            color: #6c7086;
                                            font-size: 10px;
                                            overflow: elide;
                                        }
                                    }

                                    if file.file-type == "geometry": Button {
                                        text: "3D";
                                        clicked => { view-3d(file.id); }
                                    }
                                }

                                TouchArea {
                                    clicked => { file-selected(file.id); }
                                }
                            }
                        }
                    }
                }
            }

            // Center - Tabs for different views
            TabWidget {
                horizontal-stretch: 1;

                Tab {
                    title: "Header";

                    ScrollView {
                        VerticalBox {
                            padding: 15px;
                            spacing: 15px;
                            alignment: start;

                            // Header info cards
                            for item in [
                                { label: "Manufacturer", value: header.manufacturer },
                                { label: "Author", value: header.author },
                                { label: "Format Version", value: header.format-version },
                                { label: "Created With", value: header.created-with },
                                { label: "Creation Date", value: header.creation-date },
                            ]: Rectangle {
                                height: 60px;
                                background: #313244;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 12px;
                                    spacing: 4px;

                                    Text {
                                        text: item.label;
                                        color: #6c7086;
                                        font-size: 11px;
                                    }
                                    Text {
                                        text: item.value != "" ? item.value : "(not set)";
                                        color: item.value != "" ? #cdd6f4 : #45475a;
                                        font-size: 14px;
                                        font-weight: 500;
                                    }
                                }
                            }
                        }
                    }
                }

                Tab {
                    title: "Light Sources (" + stats.light-source-count + ")";

                    ScrollView {
                        VerticalBox {
                            padding: 10px;
                            spacing: 8px;
                            alignment: start;

                            for ls in light-sources: Rectangle {
                                height: 70px;
                                background: #313244;
                                border-radius: 8px;

                                HorizontalBox {
                                    padding: 12px;
                                    spacing: 12px;

                                    // Light icon
                                    Rectangle {
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 20px;
                                        background: #f9e2af;

                                        Text {
                                            text: "ðŸ’¡";
                                            font-size: 20px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }

                                    VerticalBox {
                                        spacing: 4px;
                                        horizontal-stretch: 1;

                                        Text {
                                            text: ls.name;
                                            color: #cdd6f4;
                                            font-size: 14px;
                                            font-weight: 500;
                                        }
                                        Text {
                                            text: ls.description;
                                            color: #6c7086;
                                            font-size: 11px;
                                            overflow: elide;
                                        }
                                    }

                                    Rectangle {
                                        width: 80px;
                                        background: #45475a;
                                        border-radius: 4px;

                                        Text {
                                            text: ls.lumens + " lm";
                                            color: #f9e2af;
                                            font-size: 12px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                Tab {
                    title: "Statistics";

                    VerticalBox {
                        padding: 20px;
                        spacing: 15px;
                        alignment: start;

                        Text {
                            text: "GLDF Package Statistics";
                            color: #cdd6f4;
                            font-size: 18px;
                            font-weight: 600;
                        }

                        // Stats grid
                        HorizontalBox {
                            spacing: 15px;

                            for stat in [
                                { label: "Total Files", value: stats.file-count, color: #cdd6f4 },
                                { label: "3D Geometries", value: stats.geometry-count, color: #a6e3a1 },
                                { label: "Images", value: stats.image-count, color: #89b4fa },
                            ]: Rectangle {
                                horizontal-stretch: 1;
                                height: 80px;
                                background: #313244;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 15px;
                                    alignment: center;

                                    Text {
                                        text: stat.value;
                                        color: stat.color;
                                        font-size: 28px;
                                        font-weight: 700;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: stat.label;
                                        color: #6c7086;
                                        font-size: 12px;
                                        horizontal-alignment: center;
                                    }
                                }
                            }
                        }

                        HorizontalBox {
                            spacing: 15px;

                            for stat in [
                                { label: "Photometries", value: stats.photometry-count, color: #f9e2af },
                                { label: "Light Sources", value: stats.light-source-count, color: #fab387 },
                                { label: "Variants", value: stats.variant-count, color: #cba6f7 },
                            ]: Rectangle {
                                horizontal-stretch: 1;
                                height: 80px;
                                background: #313244;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 15px;
                                    alignment: center;

                                    Text {
                                        text: stat.value;
                                        color: stat.color;
                                        font-size: 28px;
                                        font-weight: 700;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: stat.label;
                                        color: #6c7086;
                                        font-size: 12px;
                                        horizontal-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }

                Tab {
                    title: "Raw Data";

                    ScrollView {
                        Rectangle {
                            background: #11111b;
                            border-radius: 4px;

                            Text {
                                text: selected-file-content != "" ? selected-file-content : "Select a file to view its contents";
                                color: selected-file-content != "" ? #a6adc8 : #45475a;
                                font-family: "monospace";
                                font-size: 12px;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
            }
        }

        // Status bar
        Rectangle {
            height: 28px;
            background: #313244;

            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;

                Text {
                    text: status-message;
                    color: #6c7086;
                    font-size: 11px;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                Text {
                    text: "GLDF Viewer v0.3.1 | Powered by gldf-rs + Slint";
                    color: #45475a;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }
    }
}
